- hosts: logstash
  become: yes
  serial:
    - 1
    - 33%
  roles:
    - deploy.Logstash
  post_tasks:
    - block:
        - name: Waiting for service started
          wait_for:
            port: 9600
            timeout: 120
      rescue:
        - name: Set /var/lib/logstash ownership
          file:
            path: '{{ item }}'
            state: directory
            owner: logstash
            group: logstash
            mode: 0774
            recurse: yes
          with_items:
            - '{{ logstash_log_path }}'
            - '{{ logstash_data_path }}'
        - service:
            name: logstash
            state: restarted
        - wait_for:
            port: 9600
            timeout: 120
    - include_role:
        name: deploy.Logstash
        tasks_from: report.yml
